<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
        <title>PDF Table Select Areas</title>
        <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/workspace.css')}}">

		<!--[if lte IE 8]><link href="../resources/jquery.selectareas.ie8.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
        <script type="text/javascript" src = "{{url_for('static',filename='js/jquery-1.11.3.min.js')}}"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="{{ url_for('static', filename='docs/css/bootstrap-3.3.2.min.css') }}" type="text/css">
        <script type="text/javascript" src="{{ url_for('static', filename='docs/js/bootstrap-3.3.2.min.js') }}"></script>

        <link rel="stylesheet" href="{{ url_for('static', filename='dist/css/bootstrap-multiselect.css') }}" type="text/css">
        <script type="text/javascript" src="{{ url_for('static', filename='dist/js/bootstrap-multiselect.js') }}"></script>
        <!--------------->
        
        <!-- JQUERY Select Areas plug-in -->
        <script type="text/javascript" src = "{{url_for('static',filename='js/jquery.selectareas.js')}}"></script>
        <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='resources/jquery.selectareas.css')}}">
        <!--------------------------------->

        <!-- JQUERY Tool tips plug-in -->
        <!-- <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script> -->

        <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/jquery-ui.min.css')}}">
        <script type="text/javascript" src = "{{url_for('static',filename='js/jquery-ui.min.js')}}"></script>
        <!------------------------------->

        <!-- JCanvas -->
        <script type="text/javascript" src = "{{url_for('static',filename='docs/js/jcanvas.min.js')}}"></script>
        <!------------->


        <!-- JSpreadSheet -->
        <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
        <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
        
        <script src="https://jsuites.net/v4/jsuites.js"></script>
        <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />

        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jexcel/2.1.0/css/jquery.jexcel.min.css" type="text/css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jexcel/2.1.0/css/jquery.jdropdown.min.css" type="text/css" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Material+Icons" />
        <!------------------->


        <!-- JExcel -->
        <!-- <link rel="stylesheet" href="{{url_for('static',filename='ce-master/dist/jexcel.css')}}" />
        <script src="{{url_for('static',filename='ce-master/dist/index.js')}}"></script>
        <script src="{{url_for('static',filename='ce-master/src/js/jexcel.core.js')}}"></script>
        <script src="{{url_for('static',filename='ce-master/src/js/jexcel.extensions.js')}}"></script>
        <script src="{{url_for('static',filename='ce-master/src/js/jexcel.formulars.js')}}"></script> -->
        <!------------>


        <!-- X-SpreadSheet -->
        <link rel="stylesheet" href="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.css">
        <script src="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.js"></script>
        <!------------------->

        <!-- CSS Loader -->
        <link rel="stylesheet" href="{{ url_for('static', filename='dist/css-loader.css') }}">
        <!---------------->


        

        <!-- JSpreadsheet -->
        <script src="https://jspreadsheet.com/v7/jspreadsheet.js"></script>
        <script src="https://jsuites.net/v4/jsuites.js"></script>
        <link rel="stylesheet" href="https://jspreadsheet.com/v7/jspreadsheet.css" type="text/css" />
        <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />

        <!-- JSpreadSheet Extension -->
        <script src="/static/js/autoWidth.min.js"></script>
        <script type="text/javascript" src="/static/js/jquery.techbytarun.excelexportjs.js"></script>

        <!-- Customization Functions -->
        <script src="/static/js/jspread.js"></script>
        <link rel="stylesheet" href="/static/css/jspread.css" type="text/css" />
        <script lang="javascript" src="/static/js/xlsx.full.min.js"></script>




	<!-- <link rel="icon" href="{{ url_for('static', filename='css/image/icon.png') }}"> -->
        
		<script type="text/javascript">
            // 테이블 선택 영역 표시 함수
            function set_select_areas(bboxs){
                if(bboxs != 0){
                    bboxs = bboxs.split(";");
                    
                    // $(".nowImg").selectAreas('reset');
                    
                    arrs = [];
                    for(i=0 ; i<bboxs.length ; i++){
                        var arr = bboxs[i].split(',');

                        fileDimsX = Number(arr[4])
                        fileDimsY = Number(arr[5])
                        const imageWidth = $("img.nowImg").width();
                        const imageHeight = $("img.nowImg").height();

                        scalingFactorX = fileDimsX / imageWidth;
                        scalingFactorY = fileDimsY / imageHeight;

                        arrs.push({
                            x: Number(arr[0] / scalingFactorX),
                            y: Number(arr[1]/ scalingFactorY),
                            width: Number(arr[2]/ scalingFactorX),
                            height: Number(arr[3]/ scalingFactorY),
                        });
                    }
                    $(".nowImg").selectAreas('add', arrs);
                }
                else{
                    $(".nowImg").selectAreas();
                }
            }
            
            // 테이블 선택 영역 표시 함수
            function areas_to_bbox(areas, realWidth, realHeight){
                bboxs = [];
                for(i=0 ; i<areas.length ; i++){
                    arrs = [];

                    const imageWidth = $("img.nowImg").width();
                    const imageHeight = $("img.nowImg").height();

                    scalingFactorX = realWidth / imageWidth;
                    scalingFactorY = realHeight / imageHeight;
                    arrs.push( Number(areas[i]['x'] * scalingFactorX));
                    arrs.push( Number(areas[i]['y'] * scalingFactorY));
                    arrs.push( Number(areas[i]['width'] * scalingFactorX));
                    arrs.push( Number(areas[i]['height'] * scalingFactorY));
                    arrs.push(realWidth);
                    arrs.push(realHeight);

                    bboxs.push(arrs.join(','));
                }
                bboxs = bboxs.join(";");
                return bboxs;
            }

            function destroy_select_areas(){
                $('.nowImg').selectAreas('destroy');
                $('.nowImg').removeAttr('alt');
                $('.nowImg').removeAttr('style');
                $('.nowImg').unwrap();
                $('.nowImg').attr("class", "previewImg");
            }

            // 페이지 이동 함수 (pre_page는 현재 페이지, page는 이동할 페이지)
            function move_page(pre_page, page){
                
                if($('.nowImg').attr("id") == "centerImg"){
                    destroy_select_areas();
                }
                else{
                    $('.nowImg').selectAreas('destroy');
                    $('.nowImg').unwrap().unwrap();
                    $('.nowImg').removeAttr('alt');
                    $('.nowImg').removeAttr('style');
                    $('.nowImg').attr("class", "previewImg");

                    var target = $('#centerImg');
                    $(target).unwrap();

                    $(target).selectAreas({
                        width: window.innerWidth / 3.84,
                        onChanged: debugQtyAreas
                    })
                }
                this_page = page;

                // 스크롤바를 현재 선택된 썸네일로 이동시키고 중간에 위치하게함
                document.getElementById('thumb_page_'+page).scrollIntoView({
                    behavior: 'auto',
                    block: 'center',
                    inline: 'center'
                });

                

                // thumb_img_select 클래스가 적용된 썸네일은 빨간 테두리가 표시됨 (현재 선택된 페이지라는 뜻)
                $('#thumb_page_'+pre_page).removeClass('thumb_img_select');
                $('#thumb_page_'+page).addClass('thumb_img_select');


                var target_thumb = $('.thumb_img_select').parent().parent();
                var prv_page = -1;
                var nxt_page = -1;

                if($(target_thumb).prevAll('.thumb_page:visible:first').length > 0)
                    prv_page = target_thumb.prevAll('.thumb_page:visible:first').find('.thumb_img').attr("id").replace("thumb_page_", "");
                    
                if($(target_thumb).nextAll('.thumb_page:visible:first').length > 0)
                    nxt_page = target_thumb.nextAll('.thumb_page:visible:first').find('.thumb_img').attr("id").replace("thumb_page_", "");


                $('img#centerImg').attr('src', "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+page+".png");
                
                $('img#prvImg').attr('src', "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+(Number(prv_page))+".png").load(function(){
                    // 정상 이미지 로딩, do nothing
                })
                .error(function(){
                    $(this).attr("src", "{{url_for('static', filename='job_pdf')}}/page_out_of_range.png");
                });
                $('img#nxtImg').attr('src', "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+(Number(nxt_page))+".png").load(function(){
                    // 정상 이미지 로딩, do nothing
                })
                .error(function(){
                    $(this).attr("src", "{{url_for('static', filename='job_pdf')}}/page_out_of_range.png");
                });


                $('#centerImg').wrap('<div class="image-decorator"></div>');
                $('#centerImg').addClass('nowImg');
                $('#centerImg').removeClass('previewImg');

                // $("div.image-decorator:has(#centerImg)").css("margin-left", "250px");
                $("div.image-decorator:has(#centerImg)").animate({
                    marginLeft: '250px'
                });

                // $("#top_tools").css("margin-left", "250px");
                $("#top_tools").animate({
                    marginLeft:'250px'
                });


                $("<img>").attr("src", $("img.nowImg").attr("src")).load(function(){
                    var imageWidth = this.width;
                    var imageHeight = this.height;

                    var fit_width = (imageWidth/imageHeight*100)*0.7+'vh';

                    $('.image-decorator div, .image-decorator img').css({'height':'70vh', 'width':fit_width});
                    
                    var dtd_pg = JSON.parse(localStorage.getItem("PDF__{{fileName}}"));

                    page = Number(this_page);
                    if($('.nowImg').attr('id') === 'prvImg') page=prv_page;
                    if($('.nowImg').attr('id') === 'nxtImg') page=nxt_page;

                    page = String(page);
                    if( dtd_pg.hasOwnProperty(String(page)) ){
                        set_select_areas( dtd_pg[page] );
                    }
                });

                $("#table_printer").html('');
                showAreaPreviewImg();
            }

            function sum(total, num) {
               return total + num;
            }

            function show_gs(data){
                $("#table_printer").html('');

                gs_url = data.gs_url;
                for(i=0 ; i<gs_url.length ; i++){
                    url = gs_url[i];

                    iframe = document.createElement('iframe');
                    $(iframe).attr('src', url);
                    $(iframe).css('width', data.table_width[i]+50);
                    document.getElementById('table_printer').appendChild(iframe);
                }
            }
            
            function show_jss(data){
                csvs = data.csvs;

                <!-- for(i=0 ; i<csvs.length ; i++){ -->
                for(i=0 ; i<1 ; i++){
                    data = "/static/job_pdf/{{fileName}}/page-"+this_page+"-table-"+(i+1)+".csv";
                    data = "/static/page-18-table-1.csv";

                    license_key = 'MjE3YjQyMzhhNzNhNjBjYjFmNzJmYjE3YzU0ZmQ3MDVhMzU5M2Y3MGZlMDg3MGEyODE0Mzc5ZGZjMGQ2OWEwZDM3NTg1OTFhZDQ1ODVlMDQyNzNhNzNkM2Q0ZjA4ZTkyOTI0NDBhNWU1N2UwNjQyZTkwMzU4ZTBmYTlhMmU0OTYsZXlKdVlXMWxJam9pZEdGclpXNTVNVGs1T0NJc0ltUmhkR1VpT2pFMk16RTNORFk0TURBc0ltUnZiV0ZwYmlJNld5SnNiMk5oYkdodmMzUWlMQ0pzYjJOaGJHaHZjM1FpWFN3aWNHeGhiaUk2TUN3aWMyTnZjR1VpT2xzaWRqY2lMQ0oyT0NKZGZRPT0=';
                    spreadsheet = createSheet("spreadsheet-"+i, "spreadsheet", data, license_key);
                }
                return;





                $("#table_printer").html('');

                csvs = data.csvs;
                col_width = data.col_width;

                for(i=0 ; i<csvs.length ; i++){
                    var div = document.createElement('div');
                    document.getElementById('table_printer').appendChild(div);

                    table = jspreadsheet(div, {
                        csv: "/static/job_pdf/{{fileName}}/page-"+this_page+"-table-"+(i+1)+".csv",
                        // columns:csvs[i],
                        colWidths: col_width[i],
                        rowResize: true,
                        columnResize: true,
                        toolbar:[
                            {
                                type: 'i',
                                content: 'undo',
                                onclick: function() {
                                    table.undo();
                                }
                            },
                            {
                                type: 'i',
                                content: 'redo',
                                onclick: function() {
                                    table.redo();
                                }
                            },
                            {
                                type: 'i',
                                content: 'save',
                                onclick: function () {
                                    table.download();
                                }
                            },
                            {
                                type: 'select',
                                k: 'font-family',
                                v: ['Arial','Verdana']
                            },
                            {
                                type: 'select',
                                k: 'font-size',
                                v: ['9px','10px','11px','12px','13px','14px','15px','16px','17px','18px','19px','20px']
                            },
                            {
                                type: 'i',
                                content: 'format_align_left',
                                k: 'text-align',
                                v: 'left'
                            },
                            {
                                type:'i',
                                content:'format_align_center',
                                k:'text-align',
                                v:'center'
                            },
                            {
                                type: 'i',
                                content: 'format_align_right', 
                                k: 'text-align',
                                v: 'right'
                            },
                            {
                                type: 'i',
                                content: 'format_bold',
                                k: 'font-weight',
                                v: 'bold'
                            },
                            {
                                type: 'color',
                                content: 'format_color_text',
                                k: 'color'
                            },
                            {
                                type: 'color',
                                content: 'format_color_fill',
                                k: 'background-color'
                            },
                        ],
                    });
                }
            }


            function debugQtyAreas (event, id, areas) {
                // console.log(areas.length + " areas", arguments);
                // alert(areas.length + " areas", arguments);
                var target = this;

                $("<img>").attr("src", $("img.nowImg").attr("src")).load(function(){
                    if ($(target).attr("id") == $('.nowImg').attr('id')){

                        page = Number(this_page);
                        if($(".nowImg").attr('id') === 'prvImg') page-=1;
                        if($(".nowImg").attr('id') === 'nxtImg') page+=1;
                        var this_page_thumb = $(".thumb_page_"+page);1

                        var dtd_pg = JSON.parse( localStorage.getItem("PDF__{{fileName}}") );

                        dtd_pg[page] = areas_to_bbox(areas, this.width, this.height);

                        localStorage.setItem("PDF__{{fileName}}", JSON.stringify( dtd_pg ));
                        
                        if(areas.length > 0) {
                            if(this_page_thumb.hasClass("thumb_table_none")){
                                this_page_thumb.addClass("thumb_table");
                                this_page_thumb.removeClass("thumb_table_none");
                                this_page_thumb.find(".exist_class").css("display", "inline");
                            }
                        }
                        else {
                            if(this_page_thumb.hasClass("thumb_table")){
                                this_page_thumb.removeClass("thumb_table")
                                this_page_thumb.addClass("thumb_table_none");
                                this_page_thumb.find(".exist_class").css("display", "none");
                            }
                        }
                    }


                });

            };

            function showAreaPreviewImg(){
                $(".previewImg").each(function(i){
                    if(this.naturalWidth == 0){
                        $(this).load(function (){
                            showAreaImg(this);
                        });
                    }
                    else{
                        showAreaImg(this);
                    }
                });
            }

            function showAreaImg(target){
                if ($(target).parent().is("canvas") )
                    $(target).unwrap();
                    
                var img_width = target.width;
                var img_height = target.height;

                var img_width_n = target.naturalWidth;
                var img_height_n = target.naturalHeight;

                $(target).wrap("<canvas class='preview_canvas' width='"+img_width+"' height='"+img_height+"'></canvas>")
                // $(this).wrap("<canvas class='preview_canvas' width='350px' height='auto'></canvas>")
                
                $("canvas.preview_canvas:has(#prvImg)").css("left", "0px");
                $("canvas.preview_canvas:has(#centerImg)").css("left", "250px");
                $("canvas.preview_canvas:has(#nxtImg)").css("left", "600px");
                
                var canvas = $(target).parent();
                var ctx = canvas[0].getContext("2d");
                ctx.drawImage(target, 0, 0, img_width, img_height);
                
                ctx.strokeStyle = "red";
                ctx.lineWidth = "2";
                ctx.setLineDash([5, 3]);

                scalingFactorX = img_width_n / img_width;
                scalingFactorY = img_height_n / img_height;
                
                var dtd_pg = JSON.parse(localStorage.getItem("PDF__{{fileName}}"));

                page = Number(this_page);
                if($(target).attr('id') === 'prvImg') page-=1;
                if($(target).attr('id') === 'nxtImg') page+=1;

                page = String(page);
                if( dtd_pg.hasOwnProperty(String(page)) ){
                    var arr = dtd_pg[page].split(";");
                    for(j=0 ; j<arr.length ; j++){
                        var arr2 = arr[j].split(",");
                        if(arr2.length>=4){
                            ctx.strokeRect(arr2[0]/scalingFactorX, arr2[1]/scalingFactorY, arr2[2]/scalingFactorX, arr2[3]/scalingFactorY);
                        }
                    }
                }
            }
            
			function areaToString (area) {
				return (typeof area.id === "undefined" ? "" : (area.id + ": ")) + area.x + ':' + area.y  + ' ' + area.width + 'x' + area.height + '<br />'
			}

			function output (text) {
				$('#output').html(text);
			}

			// Display areas coordinates in a div
			function displayAreas (areas) {
				var text = "";
				$.each(areas, function (id, area) {
					text += areaToString(area);
				});
				output(text);
			};


            
            if('{{detected_areas}}' != "-1"){   
                var detected_areas_origin = JSON.parse( '{{detected_areas | tojson | safe}}' );
                localStorage.setItem("PDF__{{fileName}}_origin", JSON.stringify(detected_areas_origin));

                if( localStorage.getItem("PDF__{{fileName}}") === null || localStorage.getItem("PDF__{{fileName}}") === "null"){
                    localStorage.setItem("PDF__{{fileName}}", JSON.stringify(detected_areas_origin));
                }

                var this_page = 1;
                var table_data;

                $( document ).tooltip();
                    
                var selectionExists;
            }
            else if(!(localStorage.getItem("PDF__{{fileName}}") === "null")){
                var this_page = 1;
                var table_data;

                $( document ).tooltip();
                    
                var selectionExists;
            }


			$(document).ready(function () {
                show_jss("a");
                setPop();
                console.log(localStorage.getItem("PDF__{{fileName}}"));
                if (!(localStorage.getItem("PDF__{{fileName}}") === "null" || localStorage.getItem("PDF__{{fileName}}") === null )){
                    var dtd_pg = JSON.parse(localStorage.getItem("PDF__{{fileName}}"));

                    var htmls = "";

                    for(idx=1 ; idx<Object.keys(dtd_pg).length+1 ; idx++){
                        var tables_len = dtd_pg[idx].length;

                        if (tables_len > 0){
                            htmls += "<div class='thumb_page thumb_page_"+idx+" thumb_table thumb_check_none'>\
                                        <center>\
                                        <img src='/static/icon/check.png' class='check_page' style='display:none'>\
                                        <img src='/static/icon/table.png' class='exist_class' style='display: inline;'>\
                                        <br>";
                            if (idx == 1){
                                htmls += "<img\
                                        class='thumb_img thumb_img_select'\
                                        src=\"{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+idx+"-thumb.png\"\
                                        onclick=\"\
                                                move_page(this_page, '"+idx+"');\
                                            \"\
                                        id=\"thumb_page_"+idx+"\">";
                            }
                            else{
                                htmls += "<img\
                                            class='thumb_img'\
                                            src=\"{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+idx+"-thumb.png\"\
                                            onclick=\"\
                                                    move_page(this_page, '"+idx+"');\
                                                \"\
                                            id=\"thumb_page_"+idx+"\">";
                            }
                            htmls += "<br>\
                                        <span>"+idx+"</span>\
                                        <br>\
                                    </center>\
                                </div>";
                        }
                        else{
                            htmls += "<div class='thumb_page thumb_page_"+idx+" thumb_table_none thumb_check_none'>\
                                        <center>\
                                            <img src='/static/icon/check.png' class='check_page' style='display: none'>\
                                            <img src='/static/icon/table.png' class='exist_class' style='display: none;'>\
                                            <br>";
                            if (idx == 1){
                                htmls += "<img\
                                            class='thumb_img thumb_img_select'\
                                            src=\"{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+idx+"-thumb.png\"\
                                            onclick=\"\
                                                    move_page(this_page, '"+idx+"');\
                                                \"\
                                            id=\"thumb_page_"+idx+"\">";
                            }
                            else{
                                htmls += "<img\
                                            class='thumb_img'\
                                            src=\"{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+idx+"-thumb.png\"\
                                            onclick=\"\
                                                    move_page(this_page, '"+idx+"');\
                                                \"\
                                            id=\"thumb_page_"+idx+"\">";
                            }
                            htmls += "<br>\
                                            <span>"+idx+"</span>\
                                            <br>\
                                        </center>\
                                    </div>";
                        }
                    }

                    $("#page_list_box").append(htmls);

                    var select_items = new Set();
                    select_items.add(".thumb_page");

                    $('#page_multiple_selected').multiselect({
                        onChange: function(option, checked, select) {
                            var opselected = $(option).val();
                            if(checked == true) {
                                if (opselected == 'all') { select_items.add(".thumb_page"); } 
                                if (opselected == 'table') { select_items.add(".thumb_table"); } 
                                if (opselected == 'empty') { select_items.add(".thumb_table_none"); } 
                                if (opselected == 'checked') { select_items.add(".thumb_check"); } 
                                if (opselected == 'non_checked') { select_items.add(".thumb_check_none"); } 
                            }
                            else if(checked == false) {
                                if (opselected == 'all') { select_items.delete(".thumb_page"); } 
                                if (opselected == 'table') { select_items.delete(".thumb_table"); } 
                                if (opselected == 'empty') { select_items.delete(".thumb_table_none"); } 
                                if (opselected == 'checked') { select_items.delete(".thumb_check"); } 
                                if (opselected == 'non_checked') { select_items.delete(".thumb_check_none"); } 
                            }

                            // $( ".thumb_page:not("+Array.from(select_items).join('')+")" ).css("display", "none");
                            // $( Array.from(select_items).join('') ).css("display", "inline-block");
                            $( ".thumb_page:not("+Array.from(select_items).join('')+")" ).hide("slow");
                            $( Array.from(select_items).join('') ).show("slow");
                        }
                    });
                    var is_page_list_expand = false;
                    

                    // 추출할 메인 이미지 교체
                    $('img#centerImg').attr("src", "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+this_page+".png");
                    
                    $('img#prvImg').attr("src", "{{url_for('static', filename='job_pdf')}}/page_out_of_range.png");
                    $('img#nxtImg').attr("src", "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+(Number(this_page)+1)+".png");

                    $('img#centerImg').selectAreas({
                        width: window.innerWidth / 3.84,
                        onChanged: debugQtyAreas
                    }).one("load", function(){
                        var imageWidth = $('#centerImg').width();
                        var imageHeight = $('#centerImg').height();

                        var fit_width = (imageWidth/imageHeight*100)*0.7+'vh';

                        $('.image-decorator div, .image-decorator img').css({'height':'70vh', 'width':fit_width});
                        

                        if( dtd_pg.hasOwnProperty(String(this_page)) ){
                            page = String(this_page);
                            set_select_areas( dtd_pg[page] );
                        }
                    });
                    showAreaPreviewImg();
                }
                else{
                    console.log("{{split_progress}}");
                    var split_progress = JSON.parse( '{{split_progress | tojson | safe}}' );
                    
                    var values = [],
                    keys = Object.keys(split_progress),
                    i = keys.length;
                    count = 0;

                    if(i > 0){
                        auto_detect_progress();
                    }

                    var html = "<h4>Previous Jobs</h4>";

                    
                    
                    while ( i-- ) {
                        count++;

                        html += "<span id='"+keys[i].split('.')[0]+"_progress'>" + keys[i] + "</span>";
                        html += "<div class='progress'>";
                        html += "<div class='progress-bar progress-bar-striped progress-bar-animated' style='width: 0%'>0%</div>";
                        html += "</div><br>";
                    }

                    $(".left_text").html(html);

                    values = [],
                    keys = Object.keys(localStorage),
                    i = keys.length;
                    count = 0;

                    html = "<h4>Finished jobs</h4>";
                    html += "<table class='table table-hover' style='width:500px'>";
                    html += "<tr><th>#</th><th>Filename</th></tr>";
                    while ( i-- ) {
                        if(!keys[i].startsWith("PDF__") || keys[i].endsWith("_origin")){
                            continue;
                        }
                        count++;

                        html += "<tr>";
                        html += "<td>"+count+"</td>";
                        html += "<td onclick='location.href=\"/workspace?fileName="+keys[i].slice(5)+"\"' style='cursor:pointer'>"+keys[i].slice(5)+".pdf</td>";
                        html += "</tr>";
                    }
                    html += "</table>";

                    $(".right_text").html(html);
                    $(".center_text").show();
                    
                    $("#page_list_box").hide();
                    $("#page_list_size_btn").hide();
                    $("#article_table").hide();
                }


                $("#upload_page_btn").click(function(){
                    popup_window = popup_upload();
                });


                $('.arrow').click(function () {
					direction = $(this).text();
                    pre_page = Number(this_page);

                    if (direction == "◀"){
                        this_page = Number(this_page)-1;
                        if(this_page < 1){
                            this_page = 1;
                        }
                    }
                    else{
                        this_page = Number(this_page)+1;
                    }
                    move_page(pre_page, this_page);
				});

                document.addEventListener("keydown", function(event) {
                    pre_page = Number(this_page);
                    // event.preventDefault();
                    const key = event.key; // "ArrowRight", "ArrowLeft", "ArrowUp", or "ArrowDown"
                    switch (key) { // change to event.key to key to use the above variable
                        case "ArrowLeft":
                            // Left pressed
                            break;

                        case "ArrowRight":
                            // Right pressed
                            break;

                        case "ArrowUp":
                            // Up pressed
                            this_page = Number(this_page)-1;
                            if(this_page < 1){
                                this_page = 1;
                            }
                            move_page(pre_page, this_page);
                            break;

                        case "ArrowDown":
                            // Down pressed
                            this_page = Number(this_page)+1;
                            move_page(pre_page, this_page);
                            break;

                        case " ":
                            var this_page_thumb = $(".thumb_page_"+this_page);
                            if(this_page_thumb.hasClass("thumb_check")){
                                this_page_thumb.removeClass("thumb_check")
                                this_page_thumb.addClass("thumb_check_none");
                                this_page_thumb.find(".check_page").css("display", "none");
                            }
                            else{
                                this_page_thumb.addClass("thumb_check");
                                this_page_thumb.removeClass("thumb_check_none");
                                this_page_thumb.find(".check_page").css("display", "inline");
                            }
                            break;
                    }
                });
        
                
                $('#get_line_size').click(function () {
                    $('.loader').addClass("is-active");
					var selectedAreas = $('img#centerImg').selectAreas('areas');
                    
                    if (selectedAreas.length > 0) {
                        const imageWidth = $('#centerImg').width();
                        const imageHeight = $('#centerImg').height();
                    
                        var table_option = $("input[name='optradio']:checked").val();
                        var jsons = {};
                        
                        for(i=0 ; i<selectedAreas.length ; i++){
                            selectedAreas[i]['imageWidth'] = imageWidth;
                            selectedAreas[i]['imageHeight'] = imageHeight;
                            jsons[i] = JSON.stringify(selectedAreas[i]);
                        }
                        jsons = JSON.stringify(jsons);

                        $.ajax({
                            url: '/getLineScale',
                            data: {"jsons":jsons, "fileName":"{{fileName}}", "page":this_page},
                            dataType:'json',
                            type: 'POST',
                            success: function (data) {
                                $("#line_scale").val(data.line_scale);
                                $('.loader').removeClass('is-active');
                            },
                            error: function (error) {
                                console.error(error);
                                $('.loader').removeClass('is-active');
                            }
                        });
                    }
                    else{
                        alert("먼저 영역을 지정해주세요.");
                        $('.loader').removeClass('is-active');
                    }
				});
     
                
                $('#extract').click(function () {
                    $('.loader').addClass('is-active');

					var selectedAreas = $('img#centerImg').selectAreas('areas');
                    
                    if (selectedAreas.length > 0) {
                        const imageWidth = $('#centerImg').width();
                        const imageHeight = $('#centerImg').height();
                    
                        var table_option = $("input[name='optradio']:checked").val();
                        var jsons = {};
                        
                        for(i=0 ; i<selectedAreas.length ; i++){
                            selectedAreas[i]['imageWidth'] = imageWidth;
                            selectedAreas[i]['imageHeight'] = imageHeight;
                            jsons[i] = JSON.stringify(selectedAreas[i]);
                        }
                        jsons = JSON.stringify(jsons);

                        $.ajax({
                            url: '/doExtract',
                            data: {"jsons":jsons, "fileName":"{{fileName}}", "page":this_page, "table_option":table_option, "line_scale":$("#line_scale").val()},
                            dataType:'json',
                            type: 'POST',
                            success: function (data) {
                                table_data = data;

                                var bboxs = data.bboxs;
                                var jsons = data.jsons;
                                var csvs = data.csvs;
                                
                                var gs_url = data.gs_url;
                                var iframe = null;

                                // show_gs(data);
                                show_jss(data);

                                if(bboxs != 0){
                                    bboxs = bboxs.split(";");
                                    
                                    $("#centerImg").selectAreas('reset');
                                    
                                    arrs = [];
                                    for(i=0 ; i<bboxs.length ; i++){
                                        var arr = bboxs[i].split(',');
                                        
                                        arrs.push({
                                            x: Number(arr[0]),
                                            y: Number(arr[1]),
                                            width: Number(arr[2]),
                                            height: Number(arr[3]),
                                        });
                                    }
                                    
                                    $("#centerImg").selectAreas('add', arrs);

                                    $("#table_show_type").css("display", "block");
                                    $('.loader').removeClass('is-active');
                                }
                            },
                            error: function (error) {
                                console.error(error);
                                $('.loader').removeClass('is-active');
                            }
                        });
                    }
				});


                $('#auto_detect').click(function(){
                    var dtd_pg_origin = JSON.parse( localStorage.getItem("PDF__{{fileName}}_origin") );
                    var dtd_pg = JSON.parse( localStorage.getItem("PDF__{{fileName}}") );

                    page = Number(this_page);
                    if($('.nowImg').attr('id') === 'prvImg') page-=1;
                    if($('.nowImg').attr('id') === 'nxtImg') page+=1;

                    dtd_pg[page] = dtd_pg_origin[page];

                    if( dtd_pg.hasOwnProperty(String(page)) ){
                        $(".nowImg").selectAreas('reset');
                        set_select_areas( dtd_pg[page] );
                        localStorage.setItem("PDF__{{fileName}}", JSON.stringify( dtd_pg ));
                    }
                });


                $(document).on('click', '.preview_canvas', function(){
                    if ($(this).find("img").attr('src') == "{{url_for('static', filename='job_pdf')}}/page_out_of_range.png") return;
                    destroy_select_areas();
                    
                    var target = $(this).find("img");
                    $(target).unwrap();

                    $(target).wrap('<div class="image-decorator"></div>')
                    $(target).addClass('nowImg');
                    $(target).removeClass('previewImg');

                    $(target).selectAreas({
                        width: window.innerWidth / 3.84,
                        onChanged: debugQtyAreas
                    })

                    // $("div.image-decorator:has(#prvImg)").css("margin-left", "0px");
                    // $("div.image-decorator:has(#centerImg)").css("margin-left", "250px");
                    // $("div.image-decorator:has(#nxtImg)").css("margin-left", "600px");
                    
                    $("div.image-decorator:has(#prvImg)").animate({
                        marginLeft:"0"
                    });
                    $("div.image-decorator:has(#centerImg)").animate({
                        marginLeft:'250px'
                    });
                    $("div.image-decorator:has(#nxtImg)").animate({
                        marginLeft:'600px'
                    });
                    
                    if($(".nowImg").attr("id") == "nxtImg")
                        // $("#top_tools").css("margin-left", "600px");
                        $("#top_tools").animate({
                            marginLeft:'600px'
                        });


                    else if($(".nowImg").attr("id") == "prvImg")
                        $("#top_tools").animate({
                            marginLeft:'0'
                        });
                    else
                        $("#top_tools").animate({
                            marginLeft:'250px'
                        });

                    showAreaPreviewImg();

                    $("<img>").attr("src", $("img.nowImg").attr("src")).load(function(){
                        var imageWidth = this.width;
                        var imageHeight = this.height;

                        var fit_width = (imageWidth/imageHeight*100)*0.7+'vh';

                        $('.image-decorator div, .image-decorator img').css({'height':'70vh', 'width':fit_width});
                        
                        var dtd_pg = JSON.parse(localStorage.getItem("PDF__{{fileName}}"));

                        page = Number(this_page);
                        if($('.nowImg').attr('id') === 'prvImg') page-=1;
                        if($('.nowImg').attr('id') === 'nxtImg') page+=1;

                        if( dtd_pg.hasOwnProperty(String(page)) ){
                            set_select_areas( dtd_pg[page] );
                        }
                    });
                });


                $("#page_list_size_btn").click(function(){
                    if(is_page_list_expand){
                        is_page_list_expand = false;
                        // $("#page_list_box").css("width", "177px");
                        // $("#page_list_size_btn").css("left", "177px");
                        $("#page_list_box").animate({
                            width:"177px"
                        });
                        $("#page_list_size_btn").animate({
                            left:"177px"
                        });
                        $("#page_list_size_btn").text("▶");
                    }
                    else{
                        is_page_list_expand = true;
                        // $("#page_list_box").css("width", "1200px");
                        // $("#page_list_size_btn").css("left", "1200px");
                        $("#page_list_box").animate({
                            width:"1200px"
                        });
                        $("#page_list_size_btn").animate({
                            left:"1200px"
                        });
                        $("#page_list_size_btn").text("◀");
                    }
                });
                
                $("#check_page_btn").click(function(){
                    var this_page_thumb = $(".thumb_page_"+this_page);
                    if(this_page_thumb.hasClass("thumb_check")){
                        this_page_thumb.removeClass("thumb_check")
                        this_page_thumb.addClass("thumb_check_none");
                        this_page_thumb.find(".check_page").css("display", "none");
                    }
                    else{
                        this_page_thumb.addClass("thumb_check");
                        this_page_thumb.removeClass("thumb_check_none");
                        this_page_thumb.find(".check_page").css("display", "inline");
                    }
                });
			});
		</script>
	</head>

	<body>
        <div class="loader loader-default" data-text="Processing..."></div>

        {% include "menu_template.html" %}

        <div class='center_text' style='display: none'>
            <div class='left_text'></div>
            <div class='right_text'></div>
        </div>

        <div id='page_list_box'>
            <div id='page_multiple_box'>
                <select id="page_multiple_selected" class="select" multiple="multiple">
                    <option value="all" selected="selected">All</option>
                    <option value="table">Table</option>
                    <!-- Option 3 will be selected in advance ... -->
                    <option value="empty">Empty</option>
                    <option value="checked">Checked</option>
                    <option value="non_checked">non_checked</option>
                </select>
            </div>
        </div>
        <span id='page_list_size_btn'>▶</span>

       <table id='article_table'>
           <tr>
                <td>
                    <div id="wrapper">
                        <table id="top_tools">
                            <tr>
                                <td></td>
                                <td>
                                    <label title='Line Scale is the smallest length to detect PDF tables border lines'>
                                        ⯑ Line Scale&nbsp;<input style="width: 40px" type='text' id="line_scale" value="40">
                                    </label>
                                </td>
                                <td>
                                    <label class="radio-inline">
                                        <input type="radio" name="optradio" value="areas">&nbsp;&nbsp;&nbsp;table_areas
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input id='auto_detect' type='button' class='btn btn-success' value='Auto Detected'>
                                </td>
                                <td>
                                    <label>
                                        <input type='button' id="get_line_size" class="btn btn-warning" value="Get Line Size">
                                    </label>
                                </td>
                                <td>
                                    <label class="radio-inline">
                                        <input type="radio" name="optradio" value="regions" checked>&nbsp;&nbsp;&nbsp;table_regions
                                    </label>
                                </td>
                            </tr>
                        </table>

                        
                        <img class="previewImg" id="prvImg"/>

                        <div class="image-decorator">
                            <img alt="Image principale" id="centerImg" class="nowImg"/>
                        </div>
                        
                        <img class="previewImg" id="nxtImg"/>
                        
                        <center>
                            <span class="arrow">◀</span>
                            <!-- <input type="text"> -->
                            <input id="check_page_btn" type="button" class="btn btn-lg btn-info" value="Check this page">

                            <span class="arrow">▶</span>
                        </center>
                    </div>
                </td>
                
                <td style="width: 120px;">
                    <input type="button" value="검출?" style="font-size: 18px; cursor:pointer;"/>
                    <br>
                    <input type="button" id="extract" value="추출▶" style="font-size: 18px; cursor:pointer;"/>
                </td>
                
                <td style="vertical-align: top">
                    <div id='table_show_type' style='float:right; display:none'>
                        <label class="radio-inline">
                            <input type="radio" name="showradio" value="gs" onclick='show_gs(table_data)' checked>Google Sheet
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="showradio" value="jss" onclick='show_jss(table_data)'>JSpreadSheet
                        </label>
                    </div>
                    <br>

                    <div id='table_printer'></div>
                    <div id='spreadsheet'></div>
                </td>
            </tr>
       </table>
	</body>
</html>